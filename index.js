require('dotenv').config();
const express = require('express');
const axios = require('axios');

const app = express();
app.use(express.json());

const PORT = process.env.PORT || 3000;

/* ===============================
   CONFIG
================================ */
const OPENAI_API_KEY = process.env.OPENAI_API_KEY;
const LINE_TOKEN = process.env.LINE_TOKEN;
const FINNHUB_API_KEY = process.env.FINNHUB_API_KEY;

/* ===============================
   SYSTEM PROMPT
================================ */
const SYSTEM_PROMPT = `
à¸„à¸¸à¸“à¸„à¸·à¸­ AI à¸™à¸±à¸à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸•à¸¥à¸²à¸”à¸‚à¸­à¸‡à¹€à¸žà¸ˆ Signal Zeeker

à¸à¸•à¸´à¸à¸²à¸à¸²à¸£à¸•à¸­à¸š:
- à¹à¸¢à¸à¹€à¸›à¹‡à¸™à¸¢à¹ˆà¸­à¸«à¸™à¹‰à¸²à¹ƒà¸«à¸à¹ˆà¸•à¸²à¸¡à¸«à¸±à¸§à¸‚à¹‰à¸­
- à¸•à¹‰à¸­à¸‡à¸•à¸­à¸šà¸„à¸£à¸šà¸—à¸¸à¸à¸‚à¹‰à¸­: ðŸ“Š à¸ à¸²à¸žà¸£à¸§à¸¡, ðŸ§  à¸›à¸±à¸ˆà¸ˆà¸±à¸¢à¸ªà¸³à¸„à¸±à¸, âš ï¸ à¸„à¸§à¸²à¸¡à¹€à¸ªà¸µà¹ˆà¸¢à¸‡, ðŸ“ˆ à¸¡à¸¸à¸¡à¸¡à¸­à¸‡à¸•à¸¥à¸²à¸”, ðŸ“Œ à¸ªà¸£à¸¸à¸›à¹€à¸Šà¸´à¸‡à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œ
- à¹ƒà¸Šà¹‰à¸­à¸µà¹‚à¸¡à¸ˆà¸´à¹€à¸«à¸¡à¸²à¸°à¸ªà¸¡à¸à¸±à¸šà¸«à¸±à¸§à¸‚à¹‰à¸­
- à¹€à¸‚à¸µà¸¢à¸™à¸¢à¸²à¸§ à¸­à¸˜à¸´à¸šà¸²à¸¢à¸Šà¸±à¸” à¸¥à¸¶à¸ à¹€à¸«à¸¡à¸·à¸­à¸™à¸šà¸—à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸‚à¹ˆà¸²à¸§
- à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸£à¸´à¸‡à¹ƒà¸«à¹‰à¸£à¸°à¸šà¸¸à¸•à¸£à¸‡ à¹†
- à¸«à¹‰à¸²à¸¡à¸•à¸±à¸”à¸„à¸³à¸à¸¥à¸²à¸‡à¸›à¸£à¸°à¹‚à¸¢à¸„
`;

/* ===============================
   Helper: à¸œà¹ˆà¸²à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡ LINE-safe
================================ */
function splitForLine(text, maxLen = 900) {
  const messages = [];
  const paragraphs = text
    .split(/\n{2,}/)
    .map(p => p.trim())
    .filter(Boolean);

  for (const p of paragraphs) {
    if (p.length <= maxLen) {
      messages.push({ type: 'text', text: p });
    } else {
      let start = 0;
      while (start < p.length) {
        messages.push({
          type: 'text',
          text: p.substring(start, start + maxLen)
        });
        start += maxLen;
      }
    }
  }
  return messages.slice(0, 8);
}

/* ===============================
   Finnhub: à¸£à¸²à¸„à¸²à¸«à¸¸à¹‰à¸™
================================ */
async function getStockPrice(symbol) {
  try {
    const url = `https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${FINNHUB_API_KEY}`;
    const res = await axios.get(url);
    return res.data;
  } catch (err) {
    console.error('Finnhub ERROR:', err.response?.data || err.message);
    return null;
  }
}

/* ===============================
   OpenAI
================================ */
async function askOpenAI(prompt) {
  try {
    const res = await axios.post(
      'https://api.openai.com/v1/chat/completions',
      {
        model: 'gpt-3.5-turbo',
        messages: [
          { role: 'system', content: SYSTEM_PROMPT },
          { role: 'user', content: prompt }
        ],
        max_tokens: 1000,
        temperature: 0.6
      },
      {
        headers: {
          Authorization: `Bearer ${OPENAI_API_KEY}`,
          'Content-Type': 'application/json'
        }
      }
    );

    return res.data.choices[0].message.content;
  } catch (err) {
    console.error('OpenAI ERROR:', err.response?.data || err.message);
    return 'ðŸ“Œ à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸›à¸£à¸°à¸¡à¸§à¸¥à¸œà¸¥ AI à¸à¸£à¸¸à¸“à¸²à¸¥à¸­à¸‡à¹ƒà¸«à¸¡à¹ˆ';
  }
}

/* ===============================
   LINE WEBHOOK
================================ */
app.post('/webhook', async (req, res) => {
  try {
    const event = req.body.events?.[0];
    if (!event || event.type !== 'message') return res.sendStatus(200);

    const userText = event.message.text.trim();
    const symbolOnly = /^[A-Za-z]{1,6}$/.test(userText);

    let replyText = '';

    /* ===== Symbol à¸«à¸¸à¹‰à¸™ ===== */
    if (symbolOnly) {
      const symbol = userText.toUpperCase();
      const price = await getStockPrice(symbol);

      if (price) {
        replyText = `
ðŸ“Š à¸ à¸²à¸žà¸£à¸§à¸¡à¸£à¸²à¸„à¸² ${symbol}  
à¸£à¸²à¸„à¸²à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™à¸­à¸¢à¸¹à¹ˆà¸—à¸µà¹ˆ ${price.c} à¸”à¸­à¸¥à¸¥à¸²à¸£à¹Œà¸ªà¸«à¸£à¸±à¸ 
à¸£à¸²à¸„à¸²à¸ªà¸¹à¸‡à¸ªà¸¸à¸”à¸§à¸±à¸™à¸™à¸µà¹‰à¸„à¸·à¸­ ${price.h} à¸”à¸­à¸¥à¸¥à¸²à¸£à¹Œ
à¸•à¹ˆà¸³à¸ªà¸¸à¸” ${price.l} à¸”à¸­à¸¥à¸¥à¸²à¸£à¹Œ 
à¸£à¸²à¸„à¸²à¸›à¸´à¸”à¸à¹ˆà¸­à¸™à¸«à¸™à¹‰à¸²à¸­à¸¢à¸¹à¹ˆà¸—à¸µà¹ˆ ${price.pc} à¸”à¸­à¸¥à¸¥à¸²à¸£à¹Œ 


ðŸ§  à¸›à¸±à¸ˆà¸ˆà¸±à¸¢à¸ªà¸³à¸„à¸±à¸  
à¸£à¸²à¸„à¸²à¸«à¸¸à¹‰à¸™ ${symbol} à¸–à¸¹à¸à¸‚à¸±à¸šà¹€à¸„à¸¥à¸·à¹ˆà¸­à¸™à¸ˆà¸²à¸à¸›à¸±à¸ˆà¸ˆà¸±à¸¢à¸«à¸¥à¸²à¸¢à¸”à¹‰à¸²à¸™à¸—à¸±à¹‰à¸‡à¸œà¸¥à¸›à¸£à¸°à¸à¸­à¸šà¸à¸²à¸£ à¸„à¸§à¸²à¸¡à¸„à¸²à¸”à¸«à¸§à¸±à¸‡à¸‚à¸­à¸‡à¸™à¸±à¸à¸¥à¸‡à¸—à¸¸à¸™à¸•à¹ˆà¸­à¸£à¸²à¸¢à¹„à¸”à¹‰à¹ƒà¸™à¸­à¸™à¸²à¸„à¸• à¸­à¸±à¸•à¸£à¸²à¸”à¸­à¸à¹€à¸šà¸µà¹‰à¸¢ à¹à¸¥à¸°à¹à¸™à¸§à¹‚à¸™à¹‰à¸¡à¹€à¸¨à¸£à¸©à¸à¸à¸´à¸ˆà¸¡à¸«à¸ à¸²à¸„ à¹‚à¸”à¸¢à¹€à¸‰à¸žà¸²à¸°à¸à¸£à¸°à¹à¸ªà¹€à¸‡à¸´à¸™à¸—à¸¸à¸™à¸£à¸°à¸«à¸§à¹ˆà¸²à¸‡à¸ªà¸–à¸²à¸šà¸±à¸™à¹à¸¥à¸°à¸™à¸±à¸à¸¥à¸‡à¸—à¸¸à¸™à¸£à¸²à¸¢à¸¢à¹ˆà¸­à¸¢à¸—à¸µà¹ˆà¸¡à¸µà¸­à¸´à¸—à¸˜à¸´à¸žà¸¥à¸•à¹ˆà¸­à¸„à¸§à¸²à¸¡à¸œà¸±à¸™à¸œà¸§à¸™

âš ï¸ à¸„à¸§à¸²à¸¡à¹€à¸ªà¸µà¹ˆà¸¢à¸‡  
à¸«à¸¸à¹‰à¸™ ${symbol} à¸¡à¸µà¸„à¸§à¸²à¸¡à¸­à¹ˆà¸­à¸™à¹„à¸«à¸§à¸•à¹ˆà¸­à¸‚à¹ˆà¸²à¸§à¸ªà¸²à¸£à¹à¸¥à¸°à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸¨à¸£à¸©à¸à¸à¸´à¸ˆ à¸£à¸§à¸¡à¸–à¸¶à¸‡à¸™à¹‚à¸¢à¸šà¸²à¸¢à¸ à¸²à¸„à¸£à¸±à¸ à¸à¸²à¸£à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹à¸›à¸¥à¸‡à¹ƒà¸™à¸­à¸¸à¸•à¸ªà¸²à¸«à¸à¸£à¸£à¸¡à¹à¸¥à¸° Sentiment à¸‚à¸­à¸‡à¸•à¸¥à¸²à¸” à¸‹à¸¶à¹ˆà¸‡à¸­à¸²à¸ˆà¸—à¸³à¹ƒà¸«à¹‰à¹€à¸à¸´à¸”à¸à¸²à¸£à¹à¸à¸§à¹ˆà¸‡à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡à¸£à¸¸à¸™à¹à¸£à¸‡à¹ƒà¸™à¸£à¸°à¸¢à¸°à¸ªà¸±à¹‰à¸™

ðŸ“ˆ à¸¡à¸¸à¸¡à¸¡à¸­à¸‡à¸•à¸¥à¸²à¸”  
à¸ à¸²à¸žà¸£à¸§à¸¡à¸•à¸¥à¸²à¸”à¸ªà¸°à¸—à¹‰à¸­à¸™à¸§à¹ˆà¸²à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™à¸£à¸²à¸¢à¹ƒà¸«à¸à¹ˆà¸¢à¸±à¸‡à¸„à¸‡à¸£à¸­à¸›à¸±à¸ˆà¸ˆà¸±à¸¢à¹ƒà¸«à¸¡à¹ˆà¹€à¸žà¸·à¹ˆà¸­à¸à¸³à¸«à¸™à¸”à¸—à¸´à¸¨à¸—à¸²à¸‡ à¸£à¸²à¸„à¸²à¸«à¸¸à¹‰à¸™à¹ƒà¸™à¸Šà¹ˆà¸§à¸‡à¸™à¸µà¹‰à¸­à¸²à¸ˆà¹€à¸„à¸¥à¸·à¹ˆà¸­à¸™à¹„à¸«à¸§à¹ƒà¸™à¸à¸£à¸­à¸šà¹à¸„à¸š à¸à¸²à¸£à¸•à¸´à¸”à¸•à¸²à¸¡à¹à¸£à¸‡à¸‹à¸·à¹‰à¸­à¸‚à¸²à¸¢à¹à¸¥à¸°à¸›à¸£à¸´à¸¡à¸²à¸“à¸à¸²à¸£à¹€à¸—à¸£à¸”à¹€à¸›à¹‡à¸™à¸ªà¸´à¹ˆà¸‡à¸ªà¸³à¸„à¸±à¸à¹€à¸žà¸·à¹ˆà¸­à¹€à¸‚à¹‰à¸²à¹ƒà¸ˆà¸—à¸´à¸¨à¸—à¸²à¸‡à¸•à¹ˆà¸­à¹„à¸›

ðŸ“Œ à¸ªà¸£à¸¸à¸›à¹€à¸Šà¸´à¸‡à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œ  
à¸£à¸²à¸„à¸²à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™à¹€à¸›à¹‡à¸™à¹€à¸žà¸µà¸¢à¸‡à¸œà¸¥à¸¥à¸±à¸žà¸˜à¹Œ à¸ªà¹ˆà¸§à¸™à¸ªà¸´à¹ˆà¸‡à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸ˆà¸±à¸šà¸•à¸²à¸„à¸·à¸­à¹‚à¸„à¸£à¸‡à¸ªà¸£à¹‰à¸²à¸‡à¸à¸²à¸£à¹€à¸„à¸¥à¸·à¹ˆà¸­à¸™à¹„à¸«à¸§à¸‚à¸­à¸‡à¹€à¸‡à¸´à¸™à¸—à¸¸à¸™à¹à¸¥à¸°à¸žà¸¤à¸•à¸´à¸à¸£à¸£à¸¡à¸‚à¸­à¸‡à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™à¸£à¸²à¸¢à¹ƒà¸«à¸à¹ˆ à¸à¸²à¸£à¹€à¸„à¸¥à¸·à¹ˆà¸­à¸™à¹„à¸«à¸§à¹ƒà¸à¸¥à¹‰à¹‚à¸‹à¸™à¸ªà¸³à¸„à¸±à¸à¸ˆà¸°à¹€à¸›à¹‡à¸™à¸•à¸±à¸§à¸šà¸­à¸à¹€à¸à¸¡à¸–à¸±à¸”à¹„à¸›à¸‚à¸­à¸‡à¸•à¸¥à¸²à¸”
`;
      } else {
        replyText = `ðŸ“Œ à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸«à¸¸à¹‰à¸™ ${symbol} à¹„à¸”à¹‰ à¹‚à¸›à¸£à¸”à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š symbol à¸«à¸£à¸·à¸­ API Key à¸‚à¸­à¸‡ Finnhub`;
      }
    } 
    /* ===== à¸„à¸³à¸–à¸²à¸¡à¸—à¸±à¹ˆà¸§à¹„à¸› ===== */
    else {
      replyText = await askOpenAI(userText);
    }

    const messages = splitForLine(replyText);

    await axios.post(
      'https://api.line.me/v2/bot/message/reply',
      { replyToken: event.replyToken, messages },
      {
        headers: {
          Authorization: `Bearer ${LINE_TOKEN}`,
          'Content-Type': 'application/json'
        }
      }
    );

    res.sendStatus(200);
  } catch (err) {
    console.error('SERVER ERROR:', err.response?.data || err.message);
    res.sendStatus(500);
  }
});

/* ===============================
   START SERVER
================================ */
app.listen(PORT, () => {
  console.log(`ðŸš€ Signal Zeeker AI Bot running on port ${PORT}`);
});
